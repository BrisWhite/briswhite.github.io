---
title: 架构
date: 2019-03-09 11:59:51
tags: 架构,文档
---
# 好工品系统架构文档

该文描述了好工品系统当前架构和未来发展方向

## 目的

为了解决随着新需求的不断增加，更新和修复ERP变得越来越困难，系统稳定性越来越差，性能越来越低下。为了更快响应客户的需求和为了更快得到市场的反馈，降低运维成本和提高开发效率，缩短开发周期。

<!-- more -->

## 项目背景

1. 单体架构，迭代周期长
> 目前属于单体架构，如果是小团队开发或者维护一个项目的话，单体架构已经足够使用，但是当前的状况是多团队开发（例如商城和ERP项目团队）。多团队开发时由于单体架构体系过大，业务耦合严重，导致在迭代以及发布时为了维护系统稳定，必须加长开发周期。
2. 缺乏单元测试
> ERP项目以及商城项目中虽然有单元测试，但是几乎停留在表面上，几乎没有使用价值，并且覆盖率很低（只有不到三十个测试）。并且当前的单元测试项目并不属于单元测试，而是集成测试。项目发布时运行集成测试会占用大量时间。没有单元测试，相关联的业务一旦修改只能通过测试人员手动测试，带来极大的系统不稳定性。
3. 数据结构设计不合理，导致大量的性能低下的链表查询
> 原先的业务逻辑中，例如列表显示，由于字段显示的设计不合理，以及随着后期新的业务需求堆积，数据结构设计混乱，导致很多链表操作，或者长事务。整体造成数据库的性能低下，数据库出错概率极高，数据极其容易出现紊乱。
4. 安全问题
> 业务的野蛮发展，以及需求的紧迫性致使开发人员将更多的精力投入在了业务环节上，而很少在意安全方面的问题，最常见的安全问题就是为了对接多个系统，采用访问API的方式，但是被访问的API并没有有效的保护措施（仅有白名单但未使用，因为配置过于繁琐）。
5. 缺少监控
> 目前系统里虽然有少量的性能监控，但是几乎都是流于形式，很少被重视或者利用起来，除此之外虽然有记录错误日志，但是没有很好的对接报警平台，以及堆积的错误一直没人跟踪从而产生了大量的错误日志，就算使用报警平台也会使处理者疲于应付。
6. 缺少自动化集成
> 无论是ERP系统还是商城系统每次发布都要指定时间发布，或者一些开发平台或者测试平台的发布都需要测试的接入才可以正常发布，而且发布耗时长，发布流程繁琐。
7. 需求无并行，需求和开发关联的管理整合缺失
> 公司目前的业务体系正在蓬勃发展，需求大量涌入，当前团队人员虽然也不是很多，但往往也是好几个需求并行开发，一个单体应用中开发，往往会出现代码冲突或者需求冲突。
   
## 系统建设目标

1. 分布式的微服务架构
> 将ERP以及商城的所有模块切分为一个个领域或者中台服务，以此对外提供服务。
2. 容器化部署
> 使用容器部署，使应用程序具有以下优势：①、版本控制；②、持续集成；③、可移植性；④、隔离线；⑤、安全性。在将ERP或者商城中的模块拆分成一个个微服务之后，使用容器来托管运行微服务。
3. 持续集成持续部署
> 持续集成方便开发人员在提交代码之后就可以立刻进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。持续部署可以将代码尽快向可运行的开发/测试节交付，以便尽早测试。具体采用何种持续集成工具可以查看后续介绍。
4. 持续交付、敏捷开发
> 采用敏捷开发的原则，即敏捷软件开发主张适度的项目、进化开发、提前交付与持续改进，并且鼓励快速与灵活的面对开发与变更。敏捷开发相当于指导手册，持续交付属于具体执行工具。使用持续交付让我们以最快的速度进行产品迭代，从而更快的得到市场反馈。
5. 团队自治、并行开发
> 划分为一个个微服务之后，各个微服务模块可以指定由某个团队负责。各个微服务在各自的团队内独立演化，发展，甚至分裂，这样有利于技术的发展。多个团队开发负责不同的微服务之后，当有新的需求时，可以很好的划分资源以及多个团队并行开发可以更快的完成需求以及迭代任务。
6. 监控，运维和错误日志报警，安全
> 划分微服务之后，各个服务之间如何调用，各个接口的性能以及所用资源，是否报错，报错类型，请求频率等都需要有记录，并且在出现问题或者恢复现场时都可以提供查询的管理入口。

## 系统改造流程

由当前的单体架构系统逐渐改造成微服务的整体步骤如下：

### 阶段一

将ERP以及商城所依赖的项目以及其本身从原先的net framework 4.5.2升级至net framework 4.6.2，之所以升级到net framework 4.6.2而不直接升级到net standard是因为以下原因：
1. 现有的ERP以及商城项目采用的WCF作为RPC组件，net core(2.x版本)目前还不支持WCF；
2. 为了给ERP整体迁移至微服务结构做铺垫，目前的net framework 4.5.2版本存在兼容性问题；

### 阶段二

针对于某一个业务模块进行项目迁移，例如库存的出入库业务逻辑，将此业务模块迁移至单独的net standard 项目中。为了将影响范围降至最低，每次移动的业务逻辑都不会太大，不会对原有的业务代码有任何改动。

### 阶段三

以阶段二产生的独立的net standard项目进行进一步的处理，添加一个专门的消费者以提供原先的业务处理逻辑。此阶段由于会涉及到业务逻辑的改变，所以为了降低发布风险，会添加一个以租户为基准的灰度发布模式用于验证改动的业务逻辑。

### 阶段四

ERP现有的技术架构里有大量的同库以及跨库链表操作，除此之外还有很多视图，视图中又充斥着大量的链表操作。阶段三主要是解决某个业务模块的写操作，此阶段主要是为了解决业务模块的读操作。由于读操作牵扯复杂，在具体执行的时候大致分为以下三种方式执行：
1. 与产品进行沟通讨论，修改当前列表的查询方式，如去掉一些不必要的查询字段。
2. 修改业务流程，将原先部分由列表显示的字段修改为点击展开显示更多的方式来查询。即列表上只展示一些核心数据，点击展开查看详细数据(原先的列表数据)。
3. 冗余查询。将原先的列表数据冗余至单独的表中，专门用于列表查询使用。

以上三种优化方式主要根据具体的业务进行取舍。

### 阶段五

所有服务划分切割清楚之后，原先阻碍ERP以及商城项目迁移至net core环境的wcf服务基本上被完全抛弃了。此时为了更快速的迭代需求以及优化发布流程，以及综合服务器的利用率以及成本会将所有的微服务应用部署在阿里云的专有网络的容器中。基于此要求，大致分为以下几种方式执行：
1. 根据划分的微服务，将需要迁移的微服务的数据表结构以及数据复制并实时同步到专有网络中。
2. 在步骤一稳定的前提下再迁移对应的微服务至专有网络中。

以上五个阶段中，大致时间点估算如下：
1. 阶段一将在2019年1月31日之前完成
2. 阶段二、三、四都是按照某个业务模块进行拆分，属于联动项。二三四三个阶段所有完成预估至少要到2020年1月31日完成
3. 阶段五建立在所有服务拆分完毕并稳定运行的前提下，预计2020年8月31日之前完成

## 参考资料

[Introduction to .NET Framework Compatibility](https://blogs.msdn.microsoft.com/dotnet/2016/05/02/introduction-to-net-framework-compatibility/)

[微服务架构有毒，何时不使用微服务?](https://mp.weixin.qq.com/s/r_KPw-OrU67xC_PBkKfVcA)

[互联网架构实践：给飞机换引擎和安全意识十原则](https://mp.weixin.qq.com/s/1Q1iE9pry7yH70ZolJj5Ww)

[云设计模式](https://docs.microsoft.com/zh-cn/azure/architecture/patterns/)

[在 CQRS 微服务中实现读取/查询](https://docs.microsoft.com/zh-cn/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/cqrs-microservice-reads)

[《企业IT架构转型之道》读后感（一）](https://blog.csdn.net/lihua5419/article/details/80174840)

## 架构设计

### 架构分析

微服务需要按照领域进行划分，每个领域聚合的实体作为单个微服务，考虑实际现有情况和团队规模，过多的服务拆分和细化不合适，短期而言按团队规模将多个聚合实体放入一个微服务进行逻辑的代码隔离（类库级别隔离），方便后期将复杂的领域拆到单独的微服务中。

### 设计思想

#### 领域驱动设计

基于DDD的领域思想，区分场景、领域、应用的分别，避免微服务拆分错把场景和应用当领域，导致服务的拆分出现问题，理解领域中的实体，值对象，枚举，领域事件，聚合，聚合根，不应该将领域中的不同对象进行隔离拆分，诸如值对象当实体设计，并单独部署，导致不必要的分布式事务和查询需求无法满足的情况。

#### 康威定律

为了迎合公司的后期发展和组织架构的调整目标，系统架构应该向着公司的组织架构愿景进行设计。

短期而言应该解决主要问题，而不是一步到位的设计出完美的系统，做好并完成局部的改造，演化迭代。

优先拆分大系统，对于简单的几个域，可以放在一个微服务中，进行逻辑上（类库）的隔离。

#### CAP定律

系统无法容忍数据出错，即必须满足一致性，微服务的设计导致了数据的分区，即无法满足时效性。整个系统的跨服务更新不提供API操作，仅提供消息的机制。

>对于分布式事务，诸如下单扣库存，采购加库存等操作，禁止通过API接口的方式进行跨服务的数据更新，服务直接的API调用仅支持查询API，对于跨服务的更新操作，请参照 [分布式事务](#分布式事务)

### 架构体系

* 认证-JWT
> 参考同目录下：身份认证技术方案.pdf
* 监控-Skywalking,ELK
> 参考同目录下：APM文档.pdf
* 配置-Spring
> 因为当前Java已经在使用Spring cloud config作为配置中心，为了统一以及经过调研，.net 也采用此方案。
* API网关-Spring
> 使用Java的Spring cloud gateway作为API网关，经过调研，.net 也可以使用此API网关。具体参考：https://steeltoe.io/docs/
* 编排部署-Kubernetes
> 参考同目录下：容器化应用的开发和部署方案.pdf
* 分布式事务、消息总线-RabbitMQ
> 参考同目录下：分布式事务消息总线.pdf
* 缓存-Redis
> 参考同目录下：缓存.pdf
* 持续集成
> 参考同目录下：Gitlab+敏捷开发.pdf
* 持续部署
> 参考同目录下：容器化应用的开发和部署方案.pdf
* Git工作项管理
> 参考同目录下：Gitlab+敏捷开发.pdf